@model _24DH110457_MyStore.Models.ViewModel.CartIndexVM
@using System.Linq

@{
    ViewBag.Title = "GIỎ HÀNG";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Khai báo biến tính toán để tránh lỗi CS0103
    decimal totalBeforeShipping = Model?.Cart?.TotalValue() ?? 0;
}

<style>
    /* ... (CSS giữ nguyên) ... */
</style>

@* JavaScript để cập nhật số lượng (được định nghĩa trong @section Scripts) *@

<div class="container mt-5">
    <h2 class="text-primary mb-4">GIỎ HÀNG CỦA BẠN</h2>

    @* 🎯 KHỐI CODE FIX: Bắt buộc kiểm tra Model.Cart an toàn trước khi lặp *@
    @if (Model != null && Model.Cart != null && Model.Cart.Items.Any())
    {
        @* Cần AntiForgeryToken cho các thao tác POST trong form *@
        @Html.AntiForgeryToken()

        <div class="row">
            <div class="col-md-7">
                <h5 class="mb-4 text-primary">Sản phẩm trong giỏ</h5>

                <table class="table table-striped table-sm align-middle">
                    <thead>
                        <tr>
                            <th colspan="2">Sản phẩm</th>
                            <th>Đơn giá</th>
                            <th style="width: 15%;">Số lượng</th>
                            <th>Thành tiền</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @* ⚠️ SỬA LỖI: Lặp qua Model.Cart.Items *@
                        @foreach (var item in Model.Cart.Items)
                        {
                            <tr>
                                <td>
                                    <img src="@item.ProductImage" alt="@item.ProductName" style="max-height: 50px; max-width: 50px;" class="rounded" />
                                </td>
                                <td>
                                    <p class="fw-bold mb-0">@item.ProductName</p>
                                </td>
                                <td>@item.UnitPrice.ToString("N0") ₫</td>
                                <td>
                                    @* Nút số lượng *@
                                    <div class="d-flex align-items-center">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="cartUpdateQuantity(@item.ProductID, @item.Quantity - 1)">-</button>
                                        <input type="text" value="@item.Quantity" class="form-control form-control-sm mx-1" style="width: 45px; text-align: center;" readonly />
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="cartUpdateQuantity(@item.ProductID, @item.Quantity + 1)">+</button>
                                    </div>
                                </td>
                                <td class="fw-bold text-danger">@item.TotalPrice.ToString("N0") ₫</td>
                                <td>
                                    @* Nút xóa (Sử dụng button gọi JS để submit POST) *@
                                    <button type="button" class="text-danger small btn btn-link p-0"
                                            onclick="removeItem(@item.ProductID)" style="padding: 0;">
                                        Xóa
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                @Html.ActionLink("Tiếp tục mua hàng", "Index", "Home", null, new { @class = "btn btn-outline-primary mt-3" })
            </div>

            @* --- CỘT TỔNG CỘNG --- *@
            <div class="col-md-5">
                <div class="p-4 border rounded shadow-sm">
                    <h4>Tổng cộng</h4>
                    <hr />
                    @* ⚠️ SỬA LỖI: Truy cập tổng tiền thông qua Model.Cart *@
                    <p>Tổng giá trị sản phẩm: <span class="float-end">@Model.Cart.TotalValue().ToString("N0") ₫</span></p>
                    <p class="h5 mt-3">Tổng thanh toán: <span class="total-summary float-end">@Model.Cart.TotalValue().ToString("N0") ₫</span></p>

                    @Html.ActionLink("MUA HÀNG", "Checkout", "Order", null, new { @class = "btn btn-danger btn-lg w-100 mt-4" })
                </div>

                @* Logic Sản phẩm gợi ý (nếu có) *@
                @if (Model.SimilarProducts != null && Model.SimilarProducts.Any())
                {
                    <h5 class="mt-4">Sản phẩm gợi ý</h5>
                    @* ... (Code hiển thị Model.SimilarProducts) ... *@
                }
            </div>

        </div>
    }
    else
    {
        <div class="alert alert-info text-center mt-5">
            Giỏ hàng của bạn đang trống. @Html.ActionLink("Tiếp tục mua hàng", "Index", "Home", null, new { @class = "alert-link" })
        </div>
    }
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script>
        // 🎯 HÀM QUAN TRỌNG: CẬP NHẬT SỐ LƯỢNG (Dùng cho nút + và -)
        function cartUpdateQuantity(id, newQuantity) {
            if (newQuantity < 1) {
                if (confirm("Bạn có chắc chắn muốn xóa sản phẩm này khỏi giỏ hàng không?")) {
                    removeItem(id);
                }
                return;
            }

            // Tạo form POST động
            const form = document.createElement('form');
            form.method = 'post';
            form.action = '@Url.Action("UpdateQuantity", "Cart")';

            // Thêm AntiForgeryToken (BẮT BUỘC cho POST)
            const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
            if (tokenElement) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = tokenElement.value;
                form.appendChild(tokenInput);
            }

            // Thêm Product ID và Số lượng mới
            const idInput = document.createElement('input');
            idInput.type = 'hidden'; idInput.name = 'id'; idInput.value = id;
            form.appendChild(idInput);

            const quantityInput = document.createElement('input');
            quantityInput.type = 'hidden'; quantityInput.name = 'quantity'; quantityInput.value = newQuantity;
            form.appendChild(quantityInput);

            document.body.appendChild(form);
            form.submit();
        }

        // Hàm xóa sản phẩm
        function removeItem(id) {
            if (confirm("Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng không?")) {
                const form = document.createElement('form');
                form.method = 'post';
                form.action = '@Url.Action("RemoveItem", "Cart")';

                // Thêm AntiForgeryToken
                const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
                if (tokenElement) {
                    const tokenInput = document.createElement('input');
                    tokenInput.type = 'hidden';
                    tokenInput.name = '__RequestVerificationToken';
                    tokenInput.value = tokenElement.value;
                    form.appendChild(tokenInput);
                }

                // Thêm Product ID
                const idInput = document.createElement('input');
                idInput.type = 'hidden'; idInput.name = 'id'; idInput.value = id;
                form.appendChild(idInput);

                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
}