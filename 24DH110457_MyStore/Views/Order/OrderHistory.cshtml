@model IEnumerable<_24DH110457_MyStore.Models.Order>
@using System.Linq
@using System.Collections.Generic

@{
    ViewBag.Title = "Lịch sử mua hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <h2 class="text-primary mb-4">Lịch sử Đơn hàng</h2>

    @* Vùng hiển thị thông báo *@
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    @* KHỐI HIỂN THỊ ĐƠN HÀNG *@
    @if (Model != null && Model.Any())
    {
        foreach (var order in Model)
        {
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <span class="fw-bold">Đơn hàng #@order.OrderID</span>

                    @* HIỂN THỊ TRẠNG THÁI *@
                    <span class="text-@((order.Status == "Cancelled") ? "danger" : (order.Status == "Delivered" ? "success" : "warning"))">
                        Trạng thái: @order.Status
                    </span>
                </div>

                <div class="card-body">

                    <p>
                        <strong>Tổng tiền:</strong>
                        <span class="text-danger fw-bold">@order.TotalAmount.ToString("N0") ₫</span>
                    </p>

                    <p><strong>Giao đến:</strong> @(order.ShippingAddress ?? "Chưa có địa chỉ")</p>
                    <p><strong>Phương thức:</strong> @(order.PaymentMethod ?? "N/A") (@(order.ShippingMethod ?? "N/A"))</p>

                    <h6 class="mt-3">Chi tiết:</h6>
                    <ul>
                        @if (order.OrderDetails != null && order.OrderDetails.Any())
                        {
                            foreach (var detail in order.OrderDetails.Take(3))
                            {
                                <li>
                                    @(detail.Product?.ProductName ?? "Sản phẩm bị xóa") (@detail.Quantity x @detail.UnitPrice.ToString("N0") ₫)
                                </li>
                            }
                            if (order.OrderDetails.Count > 3)
                            {
                                <li>... và @(order.OrderDetails.Count - 3) sản phẩm khác.</li>
                            }
                        }
                        else
                        {
                            <li>Không có chi tiết sản phẩm.</li>
                        }
                    </ul>

                    <div class="mt-3 text-end d-flex justify-content-end">

                        @* 🎯 NÚT HỦY ĐƠN HÀNG (Chỉ hiện khi trạng thái cho phép hủy) *@
                        @if (order.Status == "Pending" || order.Status == "Processing" || string.IsNullOrEmpty(order.Status))
                        {
                            using (Html.BeginForm("CancelOrder", "Order", new { id = order.OrderID }, FormMethod.Post, new { @class = "d-inline me-2" }))
                            {
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-sm btn-danger"
                                        onclick="return confirm('Bạn có chắc chắn muốn hủy đơn hàng #@order.OrderID không?');">
                                    Hủy đơn
                                </button>
                            }
                        }

                        @Html.ActionLink("Xem Chi Tiết Đơn", "OrderSuccess", "Order", new { id = order.OrderID }, new { @class = "btn btn-sm btn-primary d-inline" })
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="alert alert-info text-center mt-5">
            <p>Bạn chưa có đơn hàng nào đang chờ xử lý.</p>
        </div>
    }
</div>